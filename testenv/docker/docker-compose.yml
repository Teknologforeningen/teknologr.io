version: '3.5'

services:
  teknologr:
    build: ../..
    hostname: teknologr
    volumes:
      - static:/opt/app/teknologr/members/static
    env_file:
      - docker.env
    depends_on:
      - db 

  db:
    image: postgres:12.0-alpine
    hostname: db
    env_file:
      - docker.env
    volumes:
      - data:/var/lib/postgresql/data/

  ldap:
    image: osixia/openldap:latest
    hostname: ldap
    env_file:
      - docker.env
    command: "--copy-service --loglevel debug"
    volumes:
      - ./init_ldap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/01-init.ldif


  nginx:
    image: nginx:latest
    hostname: nginx
    ports:
      - 443:8443
      - 80:8080
    volumes:
      - ./reverse_proxy/nginx.conf:/etc/nginx/nginx.conf
      - ./reverse_proxy/proxy.conf:/etc/nginx/conf.d/proxy.conf
      - ./reverse_proxy/ssl.conf:/etc/nginx/conf.d/ssl.conf
      - ./reverse_proxy/localhost.crt:/etc/ssl/certs/localhost.crt
      - ./reverse_proxy/localhost.key:/etc/ssl/private/localhost.key
      - static:/var/www/teknologr_static
    depends_on:
      - teknologr
  
        #  keycloak:
        #    image: quay.io/keycloak/keycloak:latest
        #    hostname: keycloak
        #    env_file: keycloak.env
        #    depends_on:
        #      - kc_postgres
        #
        #  kc_postgres:
        #    image: postgres:12.0-alpine
        #    hostname: kc_postgres
        #    env_file: keycloak.env
        #    volumes:
        #      - keycloak_data:/var/lib/postgresql/data/

volumes:
  static:
  data:
    #keycloak_data:
